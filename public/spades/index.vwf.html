<!DOCTYPE HTML>
<html>
    <head>
    <title>Cards Demo</title>
    <link href="css/cards.css" rel="stylesheet" type="text/css" />
    </head>
        <body>
			
            <div id="wrapper" class="wrapper">
            </div>
            <script type="text/javascript">
              $('#wrapper').appendTo('#vwf-root');
            </script>
            <script>
              var cardWidth = 71;
              var cardHeight = 96;
              var widthRatio = 1.0;
              var heightRatio = 1.0;
			  var canvasWidth = window.innerWidth;
			  var canvasHeight = window.innerHeight;
            var cards = [];	

			cards= [ 	{name: 'spadeAce', imagename: 'spadeAceImg', x: (canvasWidth/2) - 364, y: 125, id: 'sacard', bounce: 10, draggable: 'yes', src: 'images/s1.png'},
						{name: 'spadeTwo', imagename: 'spadeTwoImg', x: (canvasWidth/2) - 308, y: 125, id: 's2card', bounce: 10, draggable: 'yes', src: 'images/s2.png'},
						{name: 'spadeThree', imagename: 'spadeThreeImg', x: (canvasWidth/2) - 252, y: 125, id: 's3card', bounce: 10, draggable: 'yes', src: 'images/s3.png'},
						{name: 'spadeFour', imagename: 'spadeFourImg', x: (canvasWidth/2) - 196, y: 125, id: 's4card', bounce: 10, draggable: 'yes', src: 'images/s4.png'},
						{name: 'spadeFive', imagename: 'spadeFiveImg', x: (canvasWidth/2) - 140, y: 125, id: 's5card', bounce: 10, draggable: 'yes', src: 'images/s5.png'},
						{name: 'spadeSix', imagename: 'spadeSixImg', x: (canvasWidth/2) - 84, y: 125, id: 's6card', bounce: 10, draggable: 'yes', src: 'images/s6.png'},
						{name: 'spadeSeven', imagename: 'spadeSevenImg', x: (canvasWidth/2) - 28, y: 125, id: 's7card', bounce: 10, draggable: 'yes', src: 'images/s7.png'},
						{name: 'spadeEight', imagename: 'spadeEightImg', x: (canvasWidth/2) + 28, y: 125, id: 's8card', bounce: 10, draggable: 'yes', src: 'images/s8.png'},
						{name: 'spadeNine', imagename: 'spadeNineImg', x: (canvasWidth/2) + 84, y: 125, id: 's9card', bounce: 10, draggable: 'yes', src: 'images/s9.png'},
						{name: 'spadeTen', imagename: 'spadeTenImg', x: (canvasWidth/2) + 140, y: 125, id: 's10card', bounce: 10, draggable: 'yes', src: 'images/s10.png'},
						{name: 'spadeJack', imagename: 'spadeJackImg', x: (canvasWidth/2) + 196, y: 125, id: 'sjcard', bounce: 10, draggable: 'yes', src: 'images/sj.png'},
						{name: 'spadeQueen', imagename: 'spadeQueenImg', x: (canvasWidth/2) + 252, y: 125, id: 'sqcard', bounce: 10, draggable: 'yes', src: 'images/sq.png'},
						{name: 'spadeKing', imagename: 'spadeKingImg', x: (canvasWidth/2) + 308, y: 125, id: 'skcard', bounce: 10, draggable: 'yes', src: 'images/sk.png'} ];

              var stage;
              var layer;

               function createDeck() {
                  console.info( "============== createDeck ===============" );

                  stage = new Kinetic.Stage({
                    container: 'container',
                    width: canvasWidth,
					height: canvasHeight 
                  });

                  layer = new Kinetic.Layer();
                  
                  stage.name = "cardTable";
                  layer.name = "deck";

				var index;                  
				for (index = 0; index < cards.length; ++index) {
				(function() {
				var newcard = cards[index].name;
				console.info(newcard);
				var newcardimage = cards[index].imagename;
				console.info(newcardimage);
				var newcardx = cards[index].x;
				console.info(newcardx);
				var newcardy = cards[index].y;
				console.info(newcardy);
				var newcardsrc = cards[index].src;
				console.info(newcardsrc); 
				var newcardid = cards[index].id;
				console.info(newcardid);
				var newcarddrag = cards[index].draggable;
				console.info(newcarddrag);
				var newbounce = cards[index].bounce;
				console.info(newbounce);
				
				
                 var newcard = new Image();
			        var newcardimage = new Kinetic.Image({
			          x: newcardx,
			          y: canvasHeight - newcardy,
			          image: newcard,
			          width: cardWidth,
			          height: cardHeight,
			          id: newcardid,
			          draggable: newcarddrag
			        });

					newcard.src = newcardsrc; 

			        layer.add(newcardimage);
			
			
				

				 	newcardimage.on('mouseover', function() {
					var shape = stage.get('#'+newcardid)[0];
					document.body.style.cursor = 'pointer';
					
					shape.transitionTo({
						y: newcardimage.attrs.y - newbounce,
						duration: 0.001
					 });
					}, false);
					
				newcardimage.on('mouseout', function() {
					var shape = stage.get('#'+newcardid)[0];
					document.body.style.cursor = 'default';
					shape.transitionTo({
						x: newcardimage.attrs.x,
						y: newcardimage.attrs.y + newbounce,
						duration: 0.001
						});
						}, false);
			
					
		          })();



		        }


		        stage.add(layer);
		      };




		
			
               createDeck();
				
              //@ sourceURL = index.vwf.html

              vwf_view.kernel.callMethod( "index-vwf", "clientCreated", [ vwf_view.kernel.moniker() ] );

              function initCardGame() {
                $(window).unload( function(){
                  
                  // Tell the model that this player should be removed 
                  vwf_view.kernel.callMethod( "index-vwf", "removePlayer", [ vwf_view.kernel.moniker() ] ); 
                } );
              }
              $(document).ready( function(){ 
                //console.info( "$document is ready!" );
                initCardGame(); 
                
                // we need a loginDialog
                //$( "#loginDialog" ).modal('show');
              });			 

              function localStreamCaptured( url ) {
                newWindow( clientName, "video", url, clientColor );
                //setMainVideo( url, clientName, clientColor );
                vwf_view.kernel.callMethod( "index-vwf", "newClientMedia", [ vwf_view.kernel.moniker(), clientName, clientColor ] );
              }

              function connectedTo( connID ) {
                var conn = connectionCreator( connID );
                if ( vwf_view.kernel.moniker() == conn ) {
                  conn = connectionResponder( connID ); 
                }
                //console.info( "connectedTo( "+connID+" ) = " + conn );
                return conn;
              }

              function remoteUrlReceived( remoteUrl, connID ) {
                console.info( "remoteUrlReceived( "+remoteUrl+", "+connID+" )" )
                var connMoniker = connectedTo( connID );

                if ( clientMap[ connMoniker ] ) {

                  // Get the name, window color, and whether this participant is the host
                  var host = clientMap[ connMoniker ].host;
                  var name = clientMap[ connMoniker ].name;
                  var color = clientMap[ connMoniker ].color;

                  // If there are only two participants, or this user is the host, put their video feed on
                  // the main window, otherwise create a small window for them
                  if  ( ( clientCount() == 2 ) || host ) {
                    setMainVideo( remoteUrl, name, color );
                  }
                  else {
                    var $div = newWindow( name, "video", remoteUrl, color );
                    clientMap[ connMoniker ].divId = $div.attr("id");
                  }
                }
                else
                  console.error("Moniker " + connMoniker + " is not in client map");
              }

              var mediaStarted = false;
              var clientMap = {};
              function loadMedia() {
                if ( !mediaStarted ) {
                  //console.info( "======= capture media =======" );
                  mediaStarted = true;
                  vwfMedia.capture();
                }
              }
              function clientCount() {
                // the number of clients that have captured media
                var count = 1;
                for ( id in clientMap ) { count++; }
                return count;
              }

              function addClient( info ) {
                if ( clientMap[ info.moniker ] === undefined ) {
                  clientMap[ info.moniker ] = {
                    "name": info.name,
                    "color": info.color,
                    "host": info.host
                  };
                }     
              }

              function connectClients( srcMoniker, clientsToConnect ) {
                var cc = undefined; 
                for ( var i = 0; i < clientsToConnect.length; i++ ) {
                  addClient( clientsToConnect[i] );
                }
                if ( srcMoniker == vwf_view.kernel.moniker() ) {
                  var connID = undefined; 
                  for ( var i = 0; i < clientsToConnect.length; i++ ) {
                    connID = connectionID( srcMoniker, clientsToConnect[ i ].moniker );
                    vwfMedia.createPeerConnection( connID, true );
                  }  
                }
              }

              function setClientColor( color ) {
                clientColor = color;
              }



              var clientName = "";
              var clientColor = [ 0, 0, 255 ];
              $(function() {
                var loggedIn = false;
                var mediaLoaded = false;

                  require( [ 
                        "vwfMedia.js",
                       ], function() {
                    mediaLoaded = true;
                    if ( loggedIn ) {
                      loadMedia();
                    }
                  } );

                $( "#loginButton" ).click(function(e) {
                  clientName = $('#userName').val().replace(/ /g,"_");
                  $( "#loginDialog" ).modal('hide');  
                  loggedIn = true;
                  vwf_view.kernel.callMethod( "index-vwf", "playerJoined", [ vwf_view.kernel.moniker(), clientName ] );
                  if ( mediaLoaded ) {
                    loadMedia();
                  }
                  });


                  $( "#loginDialog" ).keydown(function(e) {
                    e.stopPropagation();
                }).keyup(function(e) {
                  if(e.keyCode == $.ui.keyCode.ENTER) {
                      $(this).parent().find('.ui-dialog-buttonpane button:first').click();
                    $( "#loginDialog" ).modal('hide');
                    }
                    e.stopPropagation();
                });
              });
			
			     
			
            </script>

          <!-- Dialog boxes that are shown as necessary -->
          <div id="loginDialog" title="" class="modal hide fade">
            <div class="modal-header">
              <h3>Spades Login</h3>
            </div>
            <div class="modal-body">
                <table style="margin-left: auto;margin-right: auto;width:350px;">
                  <tr>
                    <td style="vertical-align:top;width:224px;">
                      <input type="text" id="userName" class="input-large" placeholder="Your Name">
                    </td>
                    <td style="vertical-align:top;">
                      <button id="loginButton" class="btn btn-primary">Sign in</button>
                    </td>
                  </tr>
                </table>
            </div>
            <div class="modal-footer">
            </div>
          </div>

        </body>
</html>